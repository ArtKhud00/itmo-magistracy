# Практика. Configuration management

## Цель

- ознакомиться с базовыми навыками для работы с ansible
- закрепить навыки по работе с автоматизацией на Make
- подготовить "базу" для дальнейшей практики

## Задание

Требуется написать playbook, в качестве основы которого используется роль [ansistrano](https://ansistrano.com/), реализующий следующую логику:

1. Устанавливает сервис nginx:
    1. Создает каталог с наименованием сервиса в домашней директории пользователя (`/data/redXX/some_service_X`)
    2. Посредством `ansistrano.deploy` генерирует свежую версию
    3. Скачивает дистрибутив nginx
    4. Подкладывает шаблонную конфигурацию для nginx в данный каталог, полученную из каталога templates.
    5. Подкладывает статический сайт, полученный из каталога templates.
2. Останавливает сервис nginx
3. Указывает место хранения конфигурации nginx
4. Запускает этап переключения симлинка но новую версию
5. Запускает сервис nginx

Все действия выполняются под пользователем `redXX`

## Порядок выполнения

### Запрещается

- Менять наименования основного плейбука **playbook-deploy.yaml**, но можно использовать дополнительные.
- Вносить изменения в файлы hosts inventory, но нужно вносить изменения в group_vars

### 0. Генерируем среду управления

Данный шаг нужно будет запускать для каждого окружения в отдельности!!!

```sh
make generate-test # или generate-production
```

По результату выполнения команды будет сгенерировано окружение для работы со стендом.

### 1. В файле **playbook-deploy.yaml** описываем последовательность установки приложения

- deploy;
- stop;
- synchronize;
- start.

Для каждой роли указываем теги, при помощи которых будем ограничивать область применения ролей.
К примеру для роли `deploy` указываем тег `deploy`, а для роли `stop` - `deploy,stop,restart`.

### 2. Выполняем загрузку ролей `ansistrano` через ansible-galaxy

```sh
ansible-galaxy install --force ansistrano.deploy ansistrano.rollback
```

### 3. Инициализируем наши роли

Переходим в каталог roles и запускаем команду

```sh
ansible-galaxy init role %role_name% #  %role_name% - имя роли
```

### 4. Формируем роли по следующим правилам

- **deploy** - выполняет подготовку основного каталога, скачивание дистрибутива, подкладывание шаблонов.
Использует таски из `ansistrano.deploy`: setup.yml, update_code/*
- **stop** - выполняет остановку приложения, используя параметр `stop_command`
- **synchronize** - выполняет процедуру синхронизации пререлиз версии и релизной (переключает симлинк в current).
Использует таски из `ansistrano.deploy`: symlink.yml
- **stop** - выполняет запуск приложения, используя параметр `start_command`

### 5. Производим настройку inventory так, чтобы после запуска приложения на разных средах выполнялись следующие условия

- Каждый сервис должен подниматься на порту, по следующим правилам `ZXXY`:
  - `Z` начинается с цифры 9, если это окружение test, 7 если production
  - содержит `XX` номера пользователя `redXX`
  - Оканчивается на порядковый номер сервиса `Y`
- Каждый сервис должен возвращать на страницу следующую информацию:
  - Имя окружения, в рамках которого производится инсталляция
  - Имя inventory алиаса сервиса
  - Версия nginx
  - список всех хостов доступных сервисов, в рамках окружения, без текущего

### 6. Необходимо выполнить успешную установку приложения на окружения на стенд test и production

Запускаем наш playbook использую multiple inventory.
Предварительно необходимо выполнить шаг 0 для каждого окружения в которое будет производиться установка.

### 7. Прописать команду запуска сценария деплоя в Makefile

Рецепт должен содержать в себе запуск ansible-playbook с необходимыми параметрами для запуска.
При этом стоит учитывать, что смена окружения должна задаваться через env переменную: `ENVIRONMENT`.

```sh
ENVIRONMENT=production make deploy
```

### 8. Проверка работоспособности

```sh 
curl http://localhost:ZXXY
```

В результате вывода команды мы должны увидеть:

- Имя окружения, в рамках которого производится инсталляция
- Имя inventory алиаса сервиса
- Версия nginx
- список всех хостов доступных сервисов, в рамках окружения, без текущего


### 9. Публикуем изменеия в gitlab

```sh
git config --global user.email "redXX@example.com"
git config --global user.name "redXX"
git checkout -b redXX
git add .
git commit -m '%Комментарий для публикации%'
git push -u origin redXX # Если ветка присутствует ключик -u убираем
```

### Важно!

- playbook должен запускаться под become_user `redXX`
- полная установка сервисов должна запускаться под тэгом **deploy**, откат **rollback**

## Подсказки

- *Для собственных ролей используем `include_vars` из `ansistrano.deploy` defaults*
- *При выполнении скриптов stop/start необходимо переходить в каталог с приложением (используем args.chdir)*
- *Добавляем проверку того, что приложение поднялось/остановилось*
- ```make help```
- *listing.md*
