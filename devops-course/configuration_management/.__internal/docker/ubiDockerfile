FROM registry.access.redhat.com/ubi8/ubi as build
ENV container docker

STOPSIGNAL SIGRTMIN+3
# VOLUME [ "/sys/fs/cgroup" ]
# mask systemd-machine-id-commit.service - partial fix for https://bugzilla.redhat.com/show_bug.cgi?id=1472439
RUN systemctl mask systemd-remount-fs.service \
    dev-hugepages.mount \
    sys-fs-fuse-connections.mount \
    systemd-logind.service getty.target \
    console-getty.service systemd-udev-trigger.service \
    systemd-udevd.service systemd-random-seed.service systemd-machine-id-commit.service

CMD ["/sbin/init"]

FROM build
ARG USERS_COUNT=10
ENV PYTHONWARNINGS=ignore:::pkg_resources.py2_warn,:::CryptographyDeprecationWarning \
    PYTHONIOENCODING=UTF-8 \
    LC_ALL=en_US.UTF-8 \
    LANG=en_US.UTF-8 \
    PIP_NO_CACHE_DIR=off \
    GIT_SSH_COMMAND="ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no" \
    USERS_COUNT=${USERS_COUNT}
# Install packages
RUN INSTALL_PKGS="glibc-langpack-en python36 python36-devel python3-virtualenv python3-setuptools python3-pip pcre pcre-devel zlib zlib-devel openssl openssl-devel kernel-headers.x86_64 sudo openssh-server openssh-clients sshpass initscripts openldap-devel nss_wrapper libffi-devel gcc iputils wget rsync unzip tar zip jq" && \
    yum -y module enable python36 && \
    yum -y install --setopt=tsflags=nodocs $INSTALL_PKGS && \
    yum -y update && yum clean all && rm -rf /var/cache/yum && \
    echo "source scl_source enable rh-python36" >> /etc/bash.bashrc
COPY ./scripts /var/scripts
RUN sh /var/scripts/create_users.sh && \
    sed -i -e 's/^\(Defaults\s*requiretty\)/#---\1/' /etc/sudoers
RUN systemctl enable sshd.service